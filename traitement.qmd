---
title: "Traitement"
format: html
---

::: panel-tabset
```{r}
#| label: setup

library(corrplot)
library(baseph)
library(ggsci)
library(readODS)
library(janitor)
library(visdat)
library(GGally)
library(epiDisplay)
library(plotly)
library(emmeans)
library(tidyverse)
library(kableExtra)
library(gtsummary)
library(forestmodel)
library(fmsb)
library(labelled)
#
load("datas/medgachis.RData")

classeur <- "medgachis.ods"
expx <- FALSE
if (expx) {
  file.create(classeur)
  file.remove(classeur)
  write_ods(iris, classeur)
}

# sessionInfo()
theme_gtsummary_language(language = "fr", decimal.mark = ",")
theme_gtsummary_journal(journal = "jama")
options(OutDec = ",")
ptest <- list(all_continuous() ~ "t.test", all_categorical() ~ "chisq.test")
ptest2 <- list(all_continuous() ~ "paired.t.test", all_categorical() ~ "chisq.test")
stt <- list(
  all_continuous() ~ "{mean} ({sd})",
  all_categorical() ~ "{n}/{N} ({p}%)"
)
```

# Qualité des données

## Corrélations anormales

```{r}
#| label: cor-prep

corxt <- function(prof, titx) {
  tit <- paste0("Corrélations ", titx)
  prof |>
    remove_constant() |>
    mutate_if(is.factor, as.numeric) |>
    dplyr::select(!code_patient) |>
    ggcorr(drop = TRUE, hjust = 0.9) +
    labs(title = tit,
         y = "n",
         caption = "Corrélations. Validation interne du questionnaire.") +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 14, face = "bold"),
      plot.subtitle = element_text(size = 12),
      axis.title.x = element_blank(),
      legend.title = element_blank(),
      axis.title.y = element_blank(),
      ,
      axis.text.x = element_text(size = 12),
      axis.text.y = element_text(size = 12),
      legend.position = "right"
    )
}
```

```{r}
#| label: fig-corregul
#| fig-cap: Corrélations internes

tt |>
  corxt("Bloc")
```

Il n'y a pas de corrélation *anormale* pouvant gêner l'analyse.

## Données manquantes

```{r}
#| label: fig-manq-apt
#| fig-cap: Données manquantes (questionnaire traitement)

 tt |>
  dplyr::select(-c(code_patient)) |>
  vis_dat(palette = "qual")
```

Le motif du *Médicament jeté* est très mal renseigné.

# Description

```{r}
#| label: tbl-desc
#| tbl-cap: Description --trait

tt |>
  dplyr::select(-code_patient) |>
  tbl_summary(
    missing = "no",
    type = all_continuous() ~ "continuous2",
    statistic = all_continuous() ~ c("{mean} ± {sd}", "{min}, {max}")
  ) |>
  add_n() |>
  bold_labels() |>
  modify_header(label ~ " ") |>
  as_kable_extra() |>
  kable_material(c("striped", "hover")) |>
  scroll_box(width = "100%", height = "80%")
```

# Analyse

## Par médicament

On ne peut faire qu'une analyse par classe de médicament, pas par molécules (trop de classes).

Les bzd/neuroleptiques, hypnotiques & sédatifs/analgésie ont été regroupés dans la même classe.

```{r}
#| label: tab-medjet1
#| tab-cap: médicaments jetés par classe


tt |> 
drop_na(categorie_medicament, jeter) |>
tbl_cross(
  row = categorie_medicament,
  col = jeter,
  percent = "row",
  missing_text = "Non renseigné"
) |> 
  bold_labels() |>
  modify_header(label ~ " ") |> 
  as_kable_extra() |> 
   kable_material(c("striped", "hover")) |> 
   scroll_box(width = "100%", height = "650px")
```
:::

